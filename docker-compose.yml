version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: retail_postgres
    environment:
      POSTGRES_DB: retail_system
      POSTGRES_USER: sahil
      POSTGRES_PASSWORD: root
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db-init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sahil -d retail_system"]
      interval: 10s
      timeout: 5s
      retries: 5


  order-service:
    build: ./order-service
    container_name: retail_order_service
    ports:
      - "8090:8084"
    environment:
      # NEW: RabbitMQ configuration
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      warehouse1:
        condition: service_started
      warehouse2:
        condition: service_started
      warehouse3:
        condition: service_started
  
  # Warehouse Service 1
  warehouse1:
    build: ./warehouse
    container_name: retail_warehouse1
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      WAREHOUSE_ID: 1
      SERVER_PORT: 8081
      # NEW: RabbitMQ configuration
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure

  # Warehouse Service 2
  warehouse2:
    build: ./warehouse
    container_name: retail_warehouse2
    ports:
      - "8091:8091"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      WAREHOUSE_ID: 2
      SERVER_PORT: 8091
      # NEW: RabbitMQ configuration
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure

  # Warehouse Service 3
  warehouse3:
    build: ./warehouse
    container_name: retail_warehouse3
    ports:
      - "8101:8101"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      WAREHOUSE_ID: 3
      SERVER_PORT: 8101
      # NEW: RabbitMQ configuration
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure

  # Retailer Service 1
  retailer1:
    build: ./retailer
    container_name: retail_retailer1
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      WAREHOUSE_HOST: warehouse
      RETAILER_ID: 1
      SERVER_PORT: 8082
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres:
        condition: service_healthy
      warehouse1:
        condition: service_started
      warehouse2:
        condition: service_started
      warehouse3:
        condition: service_started
    restart: on-failure

  # Retailer Service 2
  retailer2:
    build: ./retailer
    container_name: retail_retailer2
    ports:
      - "8092:8092"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      WAREHOUSE_HOST: warehouse
      RETAILER_ID: 2
      SERVER_PORT: 8092
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres:
        condition: service_healthy
      warehouse1:
        condition: service_started
      warehouse2:
        condition: service_started
      warehouse3:
        condition: service_started
    restart: on-failure

  # Retailer Service 3
  retailer3:
    build: ./retailer
    container_name: retail_retailer3
    ports:
      - "8102:8102"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      WAREHOUSE_HOST: warehouse
      RETAILER_ID: 3
      SERVER_PORT: 8102
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      postgres:
        condition: service_healthy
      warehouse1:
        condition: service_started
      warehouse2:
        condition: service_started
      warehouse3:
        condition: service_started
    restart: on-failure

  # Customer Service
  customer:
    build: ./customer
    container_name: retail_customer
    ports:
      - "8083:8083"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/retail_system
      SPRING_DATASOURCE_USERNAME: sahil
      SPRING_DATASOURCE_PASSWORD: root
      RETAILER_HOST: retailer1
    depends_on:
      postgres:
        condition: service_healthy
      retailer1:
        condition: service_started
    restart: on-failure

  # React Customer UI
  customer-ui:
    build: ./customer-ui
    container_name: retail_ui
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://localhost:8083
    depends_on:
      - customer
    stdin_open: true
    tty: true

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: retail_rabbitmq
    ports:
      - "5672:5672"    # AMQP port (for applications)
      - "15672:15672"  # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
